#!/usr/bin/env python3

from argparse import ArgumentParser, Namespace
from sys import stdin
from typing import Optional

from pygments import highlight
from pygments.formatters import get_all_formatters, get_formatter_by_name
from pygments.lexer import Lexer
from pygments.lexers import get_lexer_for_filename, guess_lexer
from pygments.lexers.special import TextLexer
from pygments.styles import get_all_styles, get_style_by_name


def arg_parse() -> Namespace:
  parser = ArgumentParser()
  parser.add_argument("name", nargs="?")

  themes = sorted(get_all_styles())
  parser.add_argument("-t", "--theme",
                      choices=themes,
                      default="friendly")

  parser.add_argument("-f", "--formatter",
                      # choices=[*get_all_formatters()],
                      default="terminal16m")

  return parser.parse_args()


def slurp(name: Optional[str]) -> str:
  if name is None:
    return stdin.read()
  else:
    with open(name) as fd:
      return fd.read()


def get_lexer(file_name: str, text: str) -> Lexer:
  try:
    return get_lexer_for_filename(file_name)
  except:
    try:
      shebang, *_ = text.split("\n", 1)
      return guess_lexer(shebang)
    except:
      return TextLexer()


def main() -> None:
  args = arg_parse()
  text = slurp(args.name)

  style = get_style_by_name(args.theme)
  formatter = get_formatter_by_name(args.formatter, style=style)
  lexer = get_lexer(args.name, text)
  pretty = highlight(text, lexer=lexer, formatter=formatter)

  print(pretty, end="")


main()

